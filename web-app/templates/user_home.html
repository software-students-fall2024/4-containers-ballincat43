<!DOCTYPE html>
<html lang="en">
<head>
    <title>User Home</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for("static", filename = "styles.css") }}">
</head>

<body>
    <header>
        <h2>Welcome, {{username}}!</h2>
        <form action="{{ url_for('logout') }}" method="POST" style="margin: 0;">
            <button type="submit" class="logout-btn">Logout</button>
        </form>
    </header>

    <div class="button-container">
        <button class="action-btn", id="srecord">Start Recording</button>
        <form id = "audioInput" action="{{url_for('listen')}}" method = "Post">
            <input type="file" id="afile" name="afile" hidden>
            <button id = "done" type = "submit">Stop Recording</button>
        </form>
        <div id="information"></div>
        <button class="action-btn">Upload Audio</button>
        <form action="{{ url_for('stats', username=username) }}" method="GET" style="margin: 0;">
            <button type="submit" class="action-btn">My Stats</button>
        </form>
    </div>

    <script>
        let mediarec;
        let audio;
        const recording = document.getElementById("srecord");
        const done = document.getElementById("done");
        const afile = document.getElementById("afile");
        const aform = document.getElementById("audioInput");

        recording.addEventListener("click", async () => {
            const stream = await navigator.mediaDevices.getUserMedia({audio: true});
            mediarec = new MediaRecorder(stream);
            mediarec.ondataavailable = (event) => audio.push(event.data);
            mediarec.onstop = () => {
                const adata = new Blob(audio, {type: "audio/wav"});
                const returnfile = new File([adata], "audio.wav", {type: "audio/wav"});
                const dt = new DataTransfer();
                dt.items.add(returnfile);
                afile.files = dt.files;
            }

            mediarec.start();
        });

        done.addEventListener("click", () => {
            mediarec.stop();

            const input = new FormData(aform);
            fetch('/login', {
                method: 'POST',
                body: input
            })
            .then(response => response.json())
            .then(data => {
                common = data.common;
                document.getElementById("information").textContent = common;        
            })
        });
    </script>
</body>
</html>